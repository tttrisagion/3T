@startuml Trade Evaluation Engine Components

!include <C4/C4_Component.puml>

LAYOUT_WITH_LEGEND()
LAYOUT_TOP_DOWN()

title Component Diagram for Trade Evaluation and Execution Engine

Container_Boundary(celery_worker, "Celery Worker") {
    Component(trade_eval_engine, "Trade Evaluation Engine", "Python/Celery Task", "Orchestrates the trade decision process using optimized parameters from the optimization engine.")
    Component(market_regime_analyzer, "Market Regime Analyzer", "Python Module", "Calculates Permutation Entropy on recent market data to classify the market as 'trending' or 'noisy'.")
    Component(entry_logic, "Entry Logic", "Python Module", "Applies the configured trading strategy (e.g., 'Breakout' or 'Swing') to identify entry opportunities.")
    Component(sizing_heuristic, "Position Sizing Heuristic", "Python Module", "Calculates position size using a performance-based heuristic that modulates a base risk size.")
    Component(trade_executor, "Trade Executor", "Python Module", "Constructs and sends the final trade order.")

    Rel(trade_eval_engine, market_regime_analyzer, "Uses to filter for tradable market conditions")
    Rel(trade_eval_engine, entry_logic, "Uses to find entry signals")
    Rel(trade_eval_engine, sizing_heuristic, "Uses to determine position size")
    Rel(trade_eval_engine, trade_executor, "Uses to place the trade")
}

ContainerDb_Ext(redis, "Redis", "Provides the latest optimized parameters and real-time prices.")
ContainerDb_Ext(mariadb, "MariaDB", "Provides historical market data for analysis and performance data for sizing.")
Container_Ext(order_gateway, "Order Gateway", "FastAPI/Python", "Receives and executes the trade order.")

Rel(trade_eval_engine, redis, "Reads optimized parameters from", "Redis KV Store")
Rel(market_regime_analyzer, mariadb, "Reads historical OHLCV data from", "SQL")
Rel(sizing_heuristic, mariadb, "Reads historical performance data from", "SQL")
Rel(trade_executor, order_gateway, "Sends trade order to", "HTTPS")

note right of market_regime_analyzer
  Trading is only initiated
  if the market is classified
  as 'trending'.
end note

@enduml
