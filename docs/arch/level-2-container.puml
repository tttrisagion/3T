@startuml Trisagion System Containers
!include <C4/C4_Container.puml>

!define DEVICONS https://raw.githubusercontent.com/tupadr3/plantuml-icon-font-sprites/master/devicons
!define FONTAWESOME https://raw.githubusercontent.com/tupadr3/plantuml-icon-font-sprites/master/font-awesome-5
!include DEVICONS/python.puml
!include DEVICONS/redis.puml
!include DEVICONS/mariadb.puml
!include FONTAWESOME/user_shield.puml
!include FONTAWESOME/cogs.puml
!include FONTAWESOME/database.puml
!include FONTAWESOME/tasks.puml
!include FONTAWESOME/clock.puml
!include FONTAWESOME/line_chart.puml
!include FONTAWESOME/search.puml

LAYOUT_WITH_LEGEND()
LAYOUT_TOP_DOWN()

title Container Diagram for Trisagion Algorithmic Trading System

Person(developer, "Developer", "Develops and maintains the trading system.", $sprite="user_shield")
System_Ext(hyperliquid, "HyperLiquid Exchange", "Provides market data and trade execution.", $sprite="building")

System_Boundary(trisagion_system, "Trisagion Trading System") {

    System_Boundary(celery_services, "Celery Services") {
        Container(celery_worker, "Worker", "Python/Celery", "Executes asynchronous tasks: balance updates, market data fetching, and trading logic.", $sprite="cogs")
        Container(celery_beat, "Beat", "Python/Celery", "Schedules periodic tasks: balance updates (30s), market data (60s).", $sprite="clock")
    }
    
    Container(components, "Components Service", "Python", "General purpose service for future features or manual tasks.", $sprite="python")

    ContainerDb(redis, "Redis", "Redis", "Acts as a message broker for Celery and a key-value cache.", $sprite="redis")
    ContainerDb(mariadb, "MariaDB", "MariaDB", "Stores product, position, balance, and market data (OHLCV).", $sprite="database")
    
    System_Boundary(observability, "Observability") {
        Container(flower, "Flower", "Flower", "Web tool for monitoring Celery jobs.", $sprite="tasks")
        Container(prometheus, "Prometheus", "Prometheus", "Collects and stores metrics.", $sprite="line_chart")
        Container(grafana, "Grafana", "Grafana", "Visualizes metrics and logs.", $sprite="line_chart")
        Container(jaeger, "Jaeger", "Jaeger", "Distributed Tracing.", $sprite="search")
        Container(otel_collector, "OpenTelemetry Collector", "OTel", "Receives, processes, and exports telemetry data.", $sprite="cogs")
    }

    Rel(developer, celery_services, "Manages and develops")
    Rel(developer, components, "Manages and develops")
    Rel(developer, flower, "Monitors")
    Rel(developer, grafana, "Views dashboards on")
    
    Rel(celery_beat, celery_worker, "Schedules tasks for", "Celery")
    
    Rel(celery_worker, redis, "Uses as message broker", "TCP/IP")
    Rel(celery_worker, mariadb, "Reads/writes trading data", "SQL/TCP")
    Rel(celery_worker, hyperliquid, "Fetches market data & executes trades", "HTTPS")
    
    Rel(components, redis, "Uses for caching/messaging")
    Rel(components, celery_worker, "Dispatches tasks to")

    Rel(flower, redis, "Monitors queue", "TCP/IP")
    Rel(flower, celery_worker, "Monitors workers", "Celery")

    Rel(prometheus, flower, "Scrapes metrics from", "HTTP")
    Rel(grafana, prometheus, "Queries metrics from", "HTTP")
    Rel(grafana, mariadb, "Queries data from", "SQL")

    Rel(celery_worker, otel_collector, "Sends traces to", "gRPC")
    Rel(celery_beat, otel_collector, "Sends traces to", "gRPC")
    Rel(components, otel_collector, "Sends traces to", "gRPC")
    Rel(otel_collector, jaeger, "Exports traces to", "gRPC")
}

@enduml