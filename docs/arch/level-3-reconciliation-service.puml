@startuml Reconciliation Service Components

!include <C4/C4_Component.puml>

LAYOUT_WITH_LEGEND()
LAYOUT_TOP_DOWN()

title Component Diagram for Reconciliation Service

Container_Boundary(celery_worker, "Celery Worker") {
    Component(reconciliation_engine, "Reconciliation Engine", "Python/Celery Task", "Compares actual portfolio performance against dynamic benchmarks from the optimization engine and generates corrective orders.")
    Component(state_calculator, "State Calculator", "Python Module", "Calculates desired portfolio state from the 'runs' table.")
    Component(consensus_builder, "Consensus Builder", "Python Module", "Gathers and compares position data from MariaDB and Exchange Observers to form a consensus on the actual portfolio state.")
    Component(order_generator, "Order Generator", "Python Module", "Creates market orders to align actual positions with desired positions.")
    
    Rel(reconciliation_engine, state_calculator, "Uses to determine desired state")
    Rel(reconciliation_engine, consensus_builder, "Uses to determine actual state")
    Rel(reconciliation_engine, order_generator, "Uses to generate corrective orders")
}

ContainerDb_Ext(mariadb, "MariaDB", "Stores trading runs, positions, and other trading data.")
Container_Ext(order_gateway, "Order Gateway", "FastAPI/Python", "Executes trade orders.")
Container_Ext(exchange_observer, "Exchange Observer", "FastAPI/Python", "Provides external view of account positions.")

Rel(state_calculator, mariadb, "Reads active runs from 'runs' table", "SQL/TCP")
Rel(consensus_builder, mariadb, "Reads current positions from 'positions' table", "SQL/TCP")
Rel(consensus_builder, exchange_observer, "Fetches external positions from", "HTTP")
Rel(order_generator, order_gateway, "Sends trade orders to", "HTTP")

note right of reconciliation_engine
  Risk is managed at the portfolio level.
  A position is not closed simply because
  it is losing money, but because the
  system has discovered, via simulation,
  that better configurations exist for the
  current market conditions.
end note

@enduml
