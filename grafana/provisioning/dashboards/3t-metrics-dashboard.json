{
  "annotations": {
    "list": [
      {
        "builtIn": 1,
        "datasource": { "type": "datasource", "uid": "grafana" },
        "enable": true,
        "hide": true,
        "iconColor": "rgba(0, 211, 255, 1)",
        "name": "Annotations & Alerts",
        "type": "dashboard"
      }
    ]
  },
  "description": "3T system metrics: equity curve, run distribution, balance, queues, market data freshness",
  "editable": true,
  "fiscalYearStartMonth": 0,
  "graphTooltip": 1,
  "id": null,
  "links": [],
  "liveNow": false,
  "panels": [
    {
      "title": "Equity Curve (Active Runs Total PnL)",
      "description": "Sum of live_pnl across all runs with height IS NULL",
      "type": "timeseries",
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "gridPos": { "h": 10, "w": 24, "x": 0, "y": 0 },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "fixed", "fixedColor": "green" },
          "custom": {
            "drawStyle": "line",
            "lineInterpolation": "smooth",
            "lineWidth": 2,
            "fillOpacity": 15,
            "gradientMode": "scheme",
            "pointSize": 3,
            "showPoints": "never",
            "spanNulls": true,
            "axisCenteredZero": false,
            "axisLabel": "PnL (USD)"
          },
          "unit": "currencyUSD"
        },
        "overrides": [
          {
            "matcher": { "id": "byName", "options": "Open PnL" },
            "properties": [{ "id": "color", "value": { "mode": "fixed", "fixedColor": "super-light-green" } }]
          }
        ]
      },
      "options": {
        "tooltip": { "mode": "multi", "sort": "none" },
        "legend": { "displayMode": "list", "placement": "bottom" }
      },
      "targets": [
        {
          "expr": "providence_active_runs_pnl_total",
          "legendFormat": "Total PnL",
          "refId": "A"
        },
        {
          "expr": "providence_open_runs_pnl_total",
          "legendFormat": "Open PnL",
          "refId": "B"
        }
      ]
    },
    {
      "title": "PnL by Symbol",
      "description": "Equity curve broken down per symbol",
      "type": "timeseries",
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "gridPos": { "h": 8, "w": 24, "x": 0, "y": 10 },
      "fieldConfig": {
        "defaults": {
          "custom": {
            "drawStyle": "line",
            "lineInterpolation": "smooth",
            "lineWidth": 1,
            "fillOpacity": 10,
            "spanNulls": true,
            "axisLabel": "PnL (USD)"
          },
          "unit": "currencyUSD"
        },
        "overrides": []
      },
      "options": {
        "tooltip": { "mode": "multi", "sort": "desc" },
        "legend": { "displayMode": "table", "placement": "right", "calcs": ["last", "min", "max"] }
      },
      "targets": [
        {
          "expr": "providence_active_runs_pnl_by_symbol",
          "legendFormat": "{{symbol}}",
          "refId": "A"
        }
      ]
    },
    {
      "title": "Block Height Run Count",
      "type": "timeseries",
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "gridPos": { "h": 7, "w": 8, "x": 0, "y": 18 },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "fixed", "fixedColor": "blue" },
          "custom": {
            "drawStyle": "line",
            "lineWidth": 2,
            "fillOpacity": 10,
            "spanNulls": true,
            "axisLabel": "Runs"
          },
          "unit": "short"
        },
        "overrides": []
      },
      "targets": [
        {
          "expr": "providence_active_runs_count",
          "legendFormat": "Active Runs",
          "refId": "A"
        }
      ]
    },
    {
      "title": "Direction Distribution",
      "description": "Long / Short / Flat breakdown of active runs",
      "type": "timeseries",
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "gridPos": { "h": 7, "w": 8, "x": 8, "y": 18 },
      "fieldConfig": {
        "defaults": {
          "custom": {
            "drawStyle": "line",
            "lineWidth": 2,
            "fillOpacity": 20,
            "spanNulls": true,
            "stacking": { "mode": "normal" }
          },
          "unit": "short"
        },
        "overrides": [
          {
            "matcher": { "id": "byName", "options": "long" },
            "properties": [{ "id": "color", "value": { "mode": "fixed", "fixedColor": "green" } }]
          },
          {
            "matcher": { "id": "byName", "options": "short" },
            "properties": [{ "id": "color", "value": { "mode": "fixed", "fixedColor": "red" } }]
          },
          {
            "matcher": { "id": "byName", "options": "flat" },
            "properties": [{ "id": "color", "value": { "mode": "fixed", "fixedColor": "yellow" } }]
          }
        ]
      },
      "targets": [
        {
          "expr": "providence_active_runs_direction",
          "legendFormat": "{{direction}}",
          "refId": "A"
        }
      ]
    },
    {
      "title": "Win / Loss Ratio",
      "description": "Positive vs negative PnL run counts",
      "type": "timeseries",
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "gridPos": { "h": 7, "w": 8, "x": 16, "y": 18 },
      "fieldConfig": {
        "defaults": {
          "custom": {
            "drawStyle": "line",
            "lineWidth": 2,
            "fillOpacity": 15,
            "spanNulls": true
          },
          "unit": "short"
        },
        "overrides": [
          {
            "matcher": { "id": "byName", "options": "Positive PnL" },
            "properties": [{ "id": "color", "value": { "mode": "fixed", "fixedColor": "green" } }]
          },
          {
            "matcher": { "id": "byName", "options": "Negative PnL" },
            "properties": [{ "id": "color", "value": { "mode": "fixed", "fixedColor": "red" } }]
          }
        ]
      },
      "targets": [
        {
          "expr": "providence_active_runs_pnl_positive_count",
          "legendFormat": "Positive PnL",
          "refId": "A"
        },
        {
          "expr": "providence_active_runs_pnl_negative_count",
          "legendFormat": "Negative PnL",
          "refId": "B"
        }
      ]
    },
    {
      "title": "Account Balance",
      "type": "timeseries",
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "gridPos": { "h": 7, "w": 12, "x": 0, "y": 25 },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "fixed", "fixedColor": "super-light-blue" },
          "custom": {
            "drawStyle": "line",
            "lineWidth": 2,
            "fillOpacity": 20,
            "gradientMode": "scheme",
            "spanNulls": true,
            "axisLabel": "USD"
          },
          "unit": "currencyUSD"
        },
        "overrides": []
      },
      "targets": [
        {
          "expr": "account_balance_value",
          "legendFormat": "Account Value",
          "refId": "A"
        }
      ]
    },
    {
      "title": "Margin Usage",
      "type": "timeseries",
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "gridPos": { "h": 7, "w": 12, "x": 12, "y": 25 },
      "fieldConfig": {
        "defaults": {
          "custom": {
            "drawStyle": "line",
            "lineWidth": 2,
            "fillOpacity": 10,
            "spanNulls": true
          },
          "unit": "currencyUSD"
        },
        "overrides": [
          {
            "matcher": { "id": "byName", "options": "Margin Ratio" },
            "properties": [
              { "id": "custom.axisPlacement", "value": "right" },
              { "id": "unit", "value": "percentunit" }
            ]
          }
        ]
      },
      "targets": [
        {
          "expr": "account_margin_used",
          "legendFormat": "Margin Used",
          "refId": "A"
        },
        {
          "expr": "account_margin_ratio",
          "legendFormat": "Margin Ratio",
          "refId": "B"
        }
      ]
    },
    {
      "title": "Position Values by Symbol",
      "type": "timeseries",
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "gridPos": { "h": 7, "w": 12, "x": 0, "y": 32 },
      "fieldConfig": {
        "defaults": {
          "custom": {
            "drawStyle": "line",
            "lineWidth": 1,
            "fillOpacity": 10,
            "spanNulls": true,
            "axisLabel": "USD"
          },
          "unit": "currencyUSD"
        },
        "overrides": []
      },
      "options": {
        "tooltip": { "mode": "multi", "sort": "desc" },
        "legend": { "displayMode": "table", "placement": "right", "calcs": ["last"] }
      },
      "targets": [
        {
          "expr": "positions_value_by_symbol",
          "legendFormat": "{{symbol}}",
          "refId": "A"
        }
      ]
    },
    {
      "title": "Unrealized PnL & Open Positions",
      "type": "timeseries",
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "gridPos": { "h": 7, "w": 12, "x": 12, "y": 32 },
      "fieldConfig": {
        "defaults": {
          "custom": {
            "drawStyle": "line",
            "lineWidth": 2,
            "fillOpacity": 10,
            "spanNulls": true
          },
          "unit": "currencyUSD"
        },
        "overrides": [
          {
            "matcher": { "id": "byName", "options": "Open Positions" },
            "properties": [
              { "id": "custom.axisPlacement", "value": "right" },
              { "id": "unit", "value": "short" }
            ]
          }
        ]
      },
      "targets": [
        {
          "expr": "positions_unrealized_pnl_total",
          "legendFormat": "Unrealized PnL",
          "refId": "A"
        },
        {
          "expr": "positions_open_count",
          "legendFormat": "Open Positions",
          "refId": "B"
        }
      ]
    },
    {
      "title": "Celery Queue Depth",
      "description": "Pending tasks per priority queue. high_priority should stay near 0.",
      "type": "timeseries",
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "gridPos": { "h": 7, "w": 12, "x": 0, "y": 39 },
      "fieldConfig": {
        "defaults": {
          "custom": {
            "drawStyle": "line",
            "lineWidth": 2,
            "fillOpacity": 15,
            "spanNulls": true,
            "axisLabel": "Tasks"
          },
          "unit": "short"
        },
        "overrides": [
          {
            "matcher": { "id": "byName", "options": "high_priority" },
            "properties": [{ "id": "color", "value": { "mode": "fixed", "fixedColor": "red" } }]
          },
          {
            "matcher": { "id": "byName", "options": "low_priority" },
            "properties": [{ "id": "color", "value": { "mode": "fixed", "fixedColor": "blue" } }]
          }
        ]
      },
      "targets": [
        {
          "expr": "celery_queue_depth",
          "legendFormat": "{{queue}}",
          "refId": "A"
        }
      ]
    },
    {
      "title": "Orders (Last Hour) & Status",
      "type": "timeseries",
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "gridPos": { "h": 7, "w": 12, "x": 12, "y": 39 },
      "fieldConfig": {
        "defaults": {
          "custom": {
            "drawStyle": "line",
            "lineWidth": 2,
            "fillOpacity": 10,
            "spanNulls": true
          },
          "unit": "short"
        },
        "overrides": [
          {
            "matcher": { "id": "byName", "options": "CONFIRMED" },
            "properties": [{ "id": "color", "value": { "mode": "fixed", "fixedColor": "green" } }]
          },
          {
            "matcher": { "id": "byName", "options": "FAILED" },
            "properties": [{ "id": "color", "value": { "mode": "fixed", "fixedColor": "red" } }]
          },
          {
            "matcher": { "id": "byName", "options": "PENDING" },
            "properties": [{ "id": "color", "value": { "mode": "fixed", "fixedColor": "yellow" } }]
          }
        ]
      },
      "targets": [
        {
          "expr": "order_execution_count_by_status",
          "legendFormat": "{{status}}",
          "refId": "A"
        },
        {
          "expr": "order_execution_last_hour",
          "legendFormat": "Last Hour Total",
          "refId": "B"
        }
      ]
    },
    {
      "title": "Market Data Freshness",
      "description": "Age of most recent market data row per symbol/timeframe. Spikes indicate stale feeds.",
      "type": "timeseries",
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "gridPos": { "h": 7, "w": 12, "x": 0, "y": 46 },
      "fieldConfig": {
        "defaults": {
          "custom": {
            "drawStyle": "line",
            "lineWidth": 1,
            "fillOpacity": 5,
            "spanNulls": true,
            "axisLabel": "Age"
          },
          "unit": "s",
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "yellow", "value": 120 },
              { "color": "red", "value": 300 }
            ]
          }
        },
        "overrides": []
      },
      "options": {
        "tooltip": { "mode": "multi", "sort": "desc" },
        "legend": { "displayMode": "table", "placement": "right", "calcs": ["last"] }
      },
      "targets": [
        {
          "expr": "market_data_age_seconds",
          "legendFormat": "{{symbol}} {{timeframe}}",
          "refId": "A"
        }
      ]
    },
    {
      "title": "Stream Price Freshness",
      "description": "Age of most recent live price per symbol. Should stay under a few seconds.",
      "type": "timeseries",
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "gridPos": { "h": 7, "w": 12, "x": 12, "y": 46 },
      "fieldConfig": {
        "defaults": {
          "custom": {
            "drawStyle": "line",
            "lineWidth": 1,
            "fillOpacity": 5,
            "spanNulls": true,
            "axisLabel": "Age"
          },
          "unit": "s",
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "yellow", "value": 10 },
              { "color": "red", "value": 60 }
            ]
          }
        },
        "overrides": []
      },
      "options": {
        "tooltip": { "mode": "multi", "sort": "desc" },
        "legend": { "displayMode": "table", "placement": "right", "calcs": ["last"] }
      },
      "targets": [
        {
          "expr": "stream_data_age_seconds",
          "legendFormat": "{{symbol}}",
          "refId": "A"
        }
      ]
    },
    {
      "title": "Mean PnL per Run",
      "type": "stat",
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "gridPos": { "h": 4, "w": 6, "x": 0, "y": 53 },
      "fieldConfig": {
        "defaults": {
          "unit": "currencyUSD",
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "red", "value": null },
              { "color": "yellow", "value": 0 },
              { "color": "green", "value": 0.01 }
            ]
          }
        },
        "overrides": []
      },
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] } },
      "targets": [
        {
          "expr": "providence_active_runs_pnl_mean",
          "legendFormat": "Mean PnL",
          "refId": "A"
        }
      ]
    },
    {
      "title": "Total Completed Runs",
      "type": "stat",
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "gridPos": { "h": 4, "w": 6, "x": 6, "y": 53 },
      "fieldConfig": {
        "defaults": {
          "unit": "short",
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "blue", "value": null }
            ]
          }
        },
        "overrides": []
      },
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] } },
      "targets": [
        {
          "expr": "providence_completed_runs_total",
          "legendFormat": "Completed",
          "refId": "A"
        }
      ]
    },
    {
      "title": "Runs by Symbol",
      "type": "piechart",
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 53 },
      "fieldConfig": {
        "defaults": { "unit": "short" },
        "overrides": []
      },
      "options": {
        "reduceOptions": { "calcs": ["lastNotNull"] },
        "legend": { "displayMode": "table", "placement": "right", "values": ["value", "percent"] },
        "pieType": "donut"
      },
      "targets": [
        {
          "expr": "providence_active_runs_by_symbol",
          "legendFormat": "{{symbol}}",
          "refId": "A"
        }
      ]
    },
    {
      "title": "Run Age Distribution",
      "description": "Histogram of how long active runs have been alive",
      "type": "heatmap",
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 57 },
      "options": {
        "calculate": false,
        "yAxis": { "unit": "s" },
        "color": { "scheme": "Spectral", "mode": "scheme" },
        "tooltip": { "show": true }
      },
      "targets": [
        {
          "expr": "increase(providence_run_age_seconds_bucket[5m])",
          "legendFormat": "{{le}}",
          "refId": "A",
          "format": "heatmap"
        }
      ]
    },
    {
      "title": "Account % Change from Baseline",
      "description": "Percentage change of account value relative to the take_profit_state last_balance baseline",
      "type": "timeseries",
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "gridPos": { "h": 7, "w": 12, "x": 0, "y": 65 },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "fixed", "fixedColor": "purple" },
          "custom": {
            "drawStyle": "line",
            "lineInterpolation": "smooth",
            "lineWidth": 2,
            "fillOpacity": 15,
            "gradientMode": "scheme",
            "spanNulls": true,
            "axisLabel": "% Change"
          },
          "unit": "percentunit",
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "red", "value": null },
              { "color": "yellow", "value": 0 },
              { "color": "green", "value": 0.01 }
            ]
          }
        },
        "overrides": []
      },
      "options": {
        "tooltip": { "mode": "single", "sort": "none" },
        "legend": { "displayMode": "list", "placement": "bottom" }
      },
      "targets": [
        {
          "expr": "account_pct_change_from_baseline",
          "legendFormat": "% Change from Baseline",
          "refId": "A"
        }
      ]
    },
    {
      "title": "Max Theoretical Position Size",
      "description": "Maximum theoretical USD exposure: balance × risk_pos_pct × (1 + kelly_threshold) × SUM(ABS(position_direction))",
      "type": "timeseries",
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "gridPos": { "h": 7, "w": 12, "x": 12, "y": 65 },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "fixed", "fixedColor": "orange" },
          "custom": {
            "drawStyle": "line",
            "lineInterpolation": "smooth",
            "lineWidth": 2,
            "fillOpacity": 15,
            "gradientMode": "scheme",
            "spanNulls": true,
            "axisLabel": "USD"
          },
          "unit": "currencyUSD"
        },
        "overrides": []
      },
      "options": {
        "tooltip": { "mode": "single", "sort": "none" },
        "legend": { "displayMode": "list", "placement": "bottom" }
      },
      "targets": [
        {
          "expr": "providence_max_theoretical_position_usd",
          "legendFormat": "Max Theoretical Position",
          "refId": "A"
        }
      ]
    }
  ],
  "refresh": "15s",
  "schemaVersion": 38,
  "style": "dark",
  "tags": ["3t", "providence", "equity", "system"],
  "templating": { "list": [] },
  "time": { "from": "now-6h", "to": "now" },
  "timepicker": {},
  "timezone": "browser",
  "title": "3T System Metrics",
  "uid": "3t-system-metrics",
  "version": 1
}
